# 密集映射数据生成说明

## 概述

本项目支持两种数据准备模式：

1. **样点提取模式**（默认）：从样点位置提取光谱值
2. **密集映射模式**：对齐影像并提取所有有效像元对，用于学习密集映射关系

## 密集映射模式 vs 样点提取模式

### 样点提取模式（当前默认）
- **用途**：有地面样点盐分值的情况
- **方法**：从样点坐标位置提取各影像的光谱值
- **输出**：每个样点一行数据，包含盐分值
- **适用场景**：有138个样点的盐分值，需要建立光谱-盐分映射关系

### 密集映射模式（新增）
- **用途**：学习从卫星光谱到无人机光谱的密集映射关系
- **方法**：
  1. 将UAV影像聚合到卫星分辨率（如果需要）
  2. 对齐到同一像元网格
  3. 提取所有有效像元对（忽略nodata值）
  4. 生成密集的像元对数据
- **输出**：所有有效像元对（可能数千到数万个）
- **适用场景**：
  - 学习光谱校正映射关系
  - 大区域卫星影像校正
  - 不需要盐分值，只需要光谱映射关系

## 使用方法

### 1. 配置密集映射模式

在 `configs/data_config.yaml` 中启用：

```yaml
preprocessing:
  dense_mapping:
    enabled: true  # 启用密集映射模式
    align_to: "satellite"  # 对齐到卫星网格
    target_resolution: null  # null则使用卫星分辨率
    satellite_nodata: null  # 自动检测
    uav_nodata: 65535
    satellite_band_indices: [3, 4, 5, 8]  # S2的G, R, REG, NIR
    uav_band_indices: [1, 2, 3, 4]  # UAV的4个波段
```

### 2. 运行预处理

```bash
python main.py --mode preprocess --data_config configs/data_config.yaml
```

### 3. 输出结果

密集映射模式会生成：
- `outputs/preprocessed_data.csv`：包含所有有效像元对
- 列包括：
  - `row`, `col`: 像元行列索引
  - `x`, `y`: 地理坐标
  - `SAT_band1`, `SAT_band2`, ...: 卫星波段值
  - `UAV_band1`, `UAV_band2`, ...: 无人机波段值
  - `SAT_*`, `UAV_*`: 计算的光谱指数

## 处理流程

### 步骤1：影像聚合（如果需要）
- 如果UAV分辨率高于目标分辨率，进行块均值聚合
- 使用 `nanmean` 排除nodata值

### 步骤2：网格对齐
- 计算重叠区域
- 使用 `rasterio.warp.reproject` 对齐到同一网格
- 处理CRS不一致的情况（自动重投影）

### 步骤3：像元对提取
- 创建有效像元掩码（排除nodata值）
- 提取所有有效像元的坐标和值
- 生成DataFrame

### 步骤4：光谱指数计算
- 为卫星和无人机波段分别计算26个光谱指数

## 注意事项

1. **内存占用**：密集映射模式会生成大量数据，注意内存使用
2. **nodata值处理**：确保正确设置nodata值，无效像元会被自动排除
3. **分辨率匹配**：UAV会自动聚合到卫星分辨率
4. **空间对齐**：确保影像有重叠区域
5. **盐分值**：密集映射模式下不包含盐分值，仅用于学习光谱映射关系

## 应用场景

### 场景1：学习光谱校正映射
```
卫星影像 → [对齐] → 无人机影像
提取所有像元对 → 训练阶段一网络 → 学习映射关系
```

### 场景2：大区域应用
```
训练好的模型 → 应用到整个大区域卫星影像 → 生成校正后的光谱
```

## 与样点提取模式的对比

| 特性 | 样点提取模式 | 密集映射模式 |
|------|------------|------------|
| 数据量 | 138个样点 | 数千到数万个像元 |
| 盐分值 | ✅ 有 | ❌ 无 |
| 用途 | 盐分反演 | 光谱校正 |
| 空间覆盖 | 样点位置 | 整个重叠区域 |
| 训练目标 | 阶段二网络 | 阶段一网络 |

